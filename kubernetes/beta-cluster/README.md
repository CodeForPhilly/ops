# civic-cloud: beta-cluster

This plan is based on configuration originally generated by the [linode-cli](https://github.com/linode/linode-cli) tool and then tweaked following the documentation for the underlying [terraform-linode-k8s](https://github.com/linode/terraform-linode-k8s) terraform module.

## Using virtual bastion

From this directory:

```bash
# tell git that keybase submodules are OK
export GIT_ALLOW_PROTOCOL=keybase:ssh

# ensure this repository is cloned recursively
git submodule update --init

# enter studio
hab studio enter

# enjoy!
kubectl get nodes
linode-cli linodes list
```

### Get into dashboard

```bash
KUBE_ADMIN_TOKEN_NAME=$(kubectl get secret -n kube-system | grep cfp-admin-token | awk '{print $1}')
kubectl describe secret -n kube-system "${KUBE_ADMIN_TOKEN_NAME}"
# copy token
kubectl proxy
# open http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login
# login with token
```

## Cluster journal

### Cluster created

```bash
./linode-create.sh
```

### Dashboard installed

```bash
kubectl apply -f kubernetes-dashboard.yaml
kubectl apply -f serviceaccount.yaml
```

## cert-manager installed

```bash
kubectl apply --validate=false -f cert-manager.yaml
# do it twice if it fails?
kubectl apply -f cert-manager.issuers.yaml
```

## ingress installed

Adopted from [How to Set Up an Nginx Ingress with Cert-Manager on DigitalOcean Kubernetes](https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-with-cert-manager-on-digitalocean-kubernetes):

```bash
kubectl apply -f ingress-nginx.yaml
kubectl apply -f ingress-nginx.loadbalancer.yaml
kubectl get svc --namespace=ingress-nginx
```
