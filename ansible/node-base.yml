#!/usr/bin/env ansible-playbook
---
- name: Install & configure node environment
  hosts: nodes
  become: true
  vars:
    dockerd_svc:
      archlinux: docker
  tasks:
    - name: validate input vars
      assert:
        that: hostvars[inventory_hostname][item] is defined
        fail_msg: "missing required variable: {{ item }}"
        success_msg: "{{ item }} is defined"
      loop:
        - node_volstorage_device
        - node_volstorage_fstype
        - node_volstorage_mountpoint
        - node_volmount_path
        - node_projects_path
        - node_admin_authorized_keys

    - name: node software installation
      include_tasks: "tasks/node-install-{{ ansible_distribution|lower }}.yml"

    - name: dockerd configuration
      notify: reload dockerd
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "ipv6": true
          }

    - name: dockerd service
      service:
        name: "{{ dockerd_svc[ansible_distribution|lower] }}"
        state: started
        enabled: true

    - name: create system directories
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ node_volstorage_mountpoint }}"
        - "{{ node_volmount_path }}"
        - "{{ node_projects_path }}"

    - name: format persistent storage volume
      filesystem:
        dev: "{{ node_volstorage_device }}"
        fstype: "{{ node_volstorage_fstype }}"

    - name: mount persistent storage volume
      mount:
        src: "{{ node_volstorage_device }}"
        path: "{{ node_volstorage_mountpoint }}"
        state: mounted
        fstype: "{{ node_volstorage_fstype }}"

  handlers:

    - name: reload dockerd
      service:
        name: "{{ dockerd_svc[ansible_distribution|lower] }}"
        state: reloaded

- name: Configure admin user environment
  hosts: nodes
  tasks:
    - tags:
        - admin:env
      block:
        - name: install authorized_keys file
          copy:
            src: "{{ node_admin_authorized_keys }}"
            dest: ~/.ssh/authorized_keys
          tags:
            - admin:env:authkeys
