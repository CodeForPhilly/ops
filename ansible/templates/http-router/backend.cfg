{# Explicitly Exposed ports #}
{# (specified in svc.ports) #}
{% for port in svc.ports %}
backend {{ svc_authority_name }}_{{ port }}
        mode            http
        balance         roundrobin
        option prefer-last-server
        retries         2
        option redispatch
        timeout connect 5s
        timeout server  5s
        server-template {{ svc_authority_name }}_{{ port }}_ {{ project_instance_svc_counts[svc.name]|default(1) }} {{ svc_authority_name }}:{{ port }} resolvers local init-addr none
{% endfor %}

{# Implicitly exposed ports #}
{# (Not specified in svc.ports, but specified in route binding) #}
{% for route in svc_routes %}
{% if route.binding.port not in svc.ports %}
backend {{ svc_authority_name }}_{{ route.binding.port }}
        mode            http
        balance         roundrobin
        option prefer-last-server
        retries         2
        option redispatch
        timeout connect 5s
        timeout server  5s
        server-template {{ svc_authority_name }}_{{ route.binding.port }}_ {{ project_instance_svc_counts[svc.name]|default(1) }} {{ svc_authority_name }}:{{ route.binding.port }} resolvers local init-addr none
{% endif %}
{% endfor %}
